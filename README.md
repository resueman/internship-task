## Запуск
```git clone https://github.com/resueman/internship-task.git && cd internship-task```
```docker build -t tender-management-api-image .```
```docker run -p 8080:8080 tender-management-api-image```
Если требуемые переменные среды не заданы, то их надо будет задать или передать с docker run или указать в docker-compose

Запуск линтера осуществляется из internsip-task/tender-management-api командой:
```golangci-lint run```

## Выбор инструментов

1. Библиотека роутинга gin vs. echo
	- У нас маленький проект + ограничено время, поэтому я выбрала 2 популярных фреймворка для рассмотрения, к которым можно прикрутить валидацию: gin и echo
	- По бенчмаркам скорости и аллокациям echo показывает себя лучше gin: https://github.com/labstack/echo
	- В gin используется подход сопоставления путей по префиксам, что может создать дополнительную проблему, которую придется решать https://github.com/julienschmidt/httprouter/issues/12#issuecomment-46121392
	
2. Для валидации использован пакет https://github.com/go-playground/validator.

## Реализация

### Роутинг и валидация входных параметров
Увиденное впервые openapi.yml напугало меня своим объемом :))) поэтому сначала я использовала пакет ogen https://github.com/ogen-go/ogen для генерации кода, который сам осуществлял роутинг и предоставлял готовые методы валидации, удовлетворяющие предоставленному openapi.yml. Ogen требовал реализовать  контроллер, удовлетворяющий сгенерированному интерфейсу. 

Но потом стало интересно попытаться успеть самостоятельно реализовать валидацию и роутинг, что и было сделано. 

### Работа с базой данных
Создание таблиц для базы данных осуществляется с помощью миграций из директории migrations.

Было сделано предположение, что при тестировании работы приложения проверяющими будет осуществляться подключение к базе данных, в которой уже созданы типы и заполненные данными таблицы из условия задачи. Для такого случая мое приложение проверяет наличие в БД таблицы 'organization_responsible'. Если она есть, то происходит миграция только таблиц связанных с тендерами,  предложениями, версиями, отзывами.

На всякий случай, если такой таблицы нет, то будут мигрированы таблицы 'employee', 'organization', 'organization_responsible' и связанные с ними типы. Будут выполнены запросы на их заполнение.

### Принятые архитектурные решения
1. Хоть проект и маленький, я решила не использовать плоскую архитектуру. Было применено разделение на слои: 
	* Слой controller, отвечает за принятие запроса, валидацию входящих данных и отправку ответа клиенту.
	* Слой service содержит бизнес-логику. Он получает от контроллера уже провалидированные входящие данные, отправляет запросы в базу данных, мапит ответы из нее в модель для  пользователя. В случае некорректных на уровне логики данных service отправляет контроллеру ошибку, в зависимости от типа которой варьируются статус-коды и сообщения ответов для пользователя.
	* Слой repository отвечает за отправку запросов к базе данных
2. Service и repositoty -- это структуры из интерфейсов, каждый из которых из которых отдельно работает с тендерами, предложениями, организациями/работниками, диагностикой.
3. В pkg реализованы структуры для http-сервера и postgres базы данных
4. Получение переменных среды, регистрация слоев, базы данных, сервера происходит в методе Run() из пакета app

Хоть эти решения и сделали структуру проекта больше, но обеспечили, например, взаимозаменяемость и настраиваемость слоев, возможность тестирования каждого из них отдельно, использования mock-объектов слоев, а также более быструю ориентацию в кодовой базе

### Вопросы по условию и принятые решения

#### Вопросы разрешившиеся с обновлением условия задачи
Были вопросы: может ли пользователь быть ответственным за несколько организаций? Пользователь может создавать предложение только от имени организации или в том числе от своего имени? Что если при создании тендера пользователь передаст статус Closed: уведомить его об этом, отклонив запрос, или без уведомлений установить статус Created? Также была найдена ошибка в sql-запросах на создание таблиц. С обновлением условия задания эти вопросы разрешились.

#### Вопросы про статусы тендеров
1. Допустим, что пользователь не из организации создавшей тендер. Он отправляет запрос на получение его статуса. Можно:
	- раскрыть статус тендера,
	- раскрыть статус тендера только если он публичный, иначе вернуть "Доступ запрещен" (реализован данный вариант).
2. Можно ли отправлять предложение, если статус тендера Created или Closed? Кажется, что учитывая в т.ч. предыдущий вопрос, нет. Это и было реализовано.
3. Можно ли менять статус тендера после того, как он стал Closed на другой? Было принято решение разрешить.

Можно придумать, еще вопросы вроде: при каких статусах можно  редактировать тендер? при каких статусах можно делать rollback? Но большее показалось мне излишним усложнением.

#### Вопросы по бизнес-логике статусов предложений

Как статус Closed влияет на бизнес-логику: можно ли редактировать такие предложения? Можно ли менять статус на другой после Closed? Можно одобрять только предложения со статусом Published или с любым статусом? А если автор решит закрыть предложение после того, как оно было одобрено? А можно ли редактировать предложение после того, как оно было одобрено?

Было принято решение не усложнять, т.к. реализация всего этого может быть излишней в силу ограниченности времени на написание решения, потенциальной ошибочности моего понимания работы статусов и усложнения работы проверяющим задание. 

#### Вопрос про тип автора предложения
Непонятна механика работы параметра {authorType} предложения ('User' / 'Organization'). В последней версии задания указано: "Предложения могут создавать пользователи от имени своей организации". При такой формулировке тип автора предложения всегда 'Organization'. 
Было решено оставить возможность указывать {authorType}, не занося в БД {authorType} всегда как 'Organization'.

#### Вопросы про необязательный параметр username
1. Немного смущает "my" в `/tenders/my` и `/bids/my`, будто мы должны выдать именно тендеры / предложения отношение к которым имеет текщий пользователь. Но в условии не предусмотрена возможность определения принадлежит ли {username} автору запроса, поэтому на бизнес-логике это никак не будет отражаться.
2.  При запросах `/tenders/my`, `/tenders/{tenderId}/status`,`/bids/my` параметр {username} не является обязательным. Как это должно отражаться на бизнес логике? 
	* Принято решение, что в `/tenders/my` при отсутсвующем {username} будут выдаваться публичные тендеры
	* В `/tenders/{tenderId}/status` мы будем выдавать только Published статус тендера при отсутствующем {username}. Если же тендер имеет другой статус, то будем просить пользователя указать {username}. 
	* Принято решение, что в `/bids/my` при отсутсвующем {username} будем просить указать его, потому что к предложениям, вне зависимости от статуса, имеют доступ только их автор и  организаторы тендера, к которому относится бид.

#### Вопрос про просмотр отзывов на предложение автора
При запросе отзывов указывается {authorUsername}, имя пользователя автора предложений, отзывы на которые нужно просмотреть.
При создании предложения передавался параметр {authorType}, который равен 'User' или 'Organization'. Кажется, это может отражаться на бизнес логике просмотра отзывов автора предложения к тендеру. Видится 2 варианта реализации:

1. Выдавать отзывы на предложения автора с именем {authorUsername}, учитывая тип предложения, который он создал для тендера с заданным {tenderId}. 
Т.е. по {tenderId} и {authorUsername} мы получаем предложение к тендеру. 
	- Если {authorType} предложения равен 'Organization', то будут выдаваться отзывы на предложения организации, к которой принадлжежит автор предложения с именем {authorUsername}. 
	- Если {authorType} предложения равен 'User', то будут выдаваться отзывы на предложения,  где пользователь с {authorUsername} является автором бида.

	Но тут вновь возникает вопрос, а что если пользователь создал одно предложение к тендеру от себя, а другое от организации, тогда какие отзывы выдавать? А как учитывать то, что ранее был сделан вывод, что в соответствии с формулировкой задания предложения по факту всегда с {authorType} = 'Organization'? 

2. Вне зависимости от типа автора предложения, выдавать отзывы на предложения, где автором предложения является именно пользователь с именем {authorUsername}. В таком случае, если у бида {authorType} = 'Organization', то мы не узнаем отзывы на предложения этой организации, авторами которых были кто-то помимо {authorUsername}.

3. Поскольку ранее был вопрос про тип автора предложения, в котором мне показалось, что тип всегда 'Organization', напрашивается вариант с выдачей отзывов на предложения организации, ответственный за которую создал бид.

Первому варианту сопутствуют вопросы, на которые у меня нет ответов. 
Было решено реализовать второй вариант исходя из логики, что в организации может быть много ответственных м к тендеру может быть отправлено несколько предложений от разных ответственных одной организации. Поэтому пусть пользователю хочется узнать отзывы на конкретного ответственного в организации, отправившей тендер. 

### Конфигурация линтера
В файле .golangci.yml находится конфигурация линтера. Включено 86 линтеров, выключено 21. Какие-то выключены, потому что срабатывают ложно, например dupl. Какие-то выключены из-за того, что в рамках данного времени я не успела исправить их замечания, в основном это замечания связанные с именованием переменных (частое замечание -- использование Id вместо ID) или стилем комментариев. Зря ругающиеся линтеры можно настроить, но не сделано, т.к. время на выполнение ограничено.

## Итог
* Реализована базовая функциональность.
* Реализована вся дополнительная функциональность, связанная с версионированием, откатами версий, отправкой отзывов к предложениям, просмотром отзывов на предложения автора бида к заданному тендеру, принятием решения по предложению.
* Реализована валидация входных парметров запроса на уровне контроллера, препятствующая выполнению запроса в случае некорректных данных. Реализовано уведомление пользователя о том, значения для какого параметра он забыл указать / ввел неверно, и какие значения допустимы.
* Продифференцированы ошибки на уровне бизнес-логики, позволяющие уведомить пользователя о том, почему его запрос не может быть выполнен (например, невозможно создать предложение для тендера с указанным Id, если его не существует или невозможно откатить тендер к версии, которой не существует).
* Приложение реализовано с использованием многослойной архитектуры.
* Осуществено разделение уровней сервиса на сервис обрабатывающий тендеры, сервис обрабатывающий предложения, сервис диагностики (метод Ping). Уровень баз данных  разделен на такие же слои + слой для работы с организациями и работниками.
* Реализован graceful shutdown для сервера.
* Добавлено описание конфигурации линтера
